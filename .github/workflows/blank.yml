name: kubesail-reboot
on:
  push:
    branches:
      - master
  schedule:
    - cron: 3 1 * * *
  watch:
    types: started
jobs:
  build:
    runs-on: ubuntu-20.04 
    steps:
    - uses: actions/checkout@v1
    - name: Install build dependencies
      run: |
        sudo apt-get -y update
        sudo apt-get -y install wget
        sudo apt-get -y install curl
    - name: Clone source
      run: |
        cd /home/runner
        curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.16.11/bin/linux/amd64/kubectl
        chmod +x ./kubectl
        sudo mv ./kubectl /usr/bin/kubectl
    - name: go kaishi
      run: |
        mkdir /home/runner/.kube
        cat <<-EOF > /home/runner/.kube/config
        ${{ secrets.CONFIG }}
        EOF
        sed -i 's/value: config/${{ secrets.CONFIG_V2RAY }}/g' /home/runner/work/kubesail-reboot/kubesail-reboot/v2ray2.yml
        kubectl version
        kubectl get pods
        kubectl replace --force -f /home/runner/work/kubesail-reboot/kubesail-reboot/v2ray2.yml         
